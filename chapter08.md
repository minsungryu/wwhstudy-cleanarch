# 08 경계 간 매핑하기

## '매핑하지 않기' 전략

유스케이스에서 도메인 객체를 인자로 가진다.

즉, 웹 계층과 영속성 계층 애플리케이션 계층 모두 같은 모델을 사용하니 매핑을 전혀 할 필요가 없다.

그러나 웹 계층 또는 영속성 계층에 특별한 요구사항이 있을 수 있다.

그럴 경우 도메인과 애플리케이션 계층은 특별한 요구사항에 관심이 없음에도 불구하고 다뤄야한다.

이는 `단일 책임 원칙`을 위반한다.

그러나 이 전략이 들어맞을 때도 있다. 간단한 CRUD 유스케이스라면 필요하지 않다.

이후 도메인 계층에서 웹과 영속성 문제를 다루게 되면 그 때는 다른 전략을 취해야 한다.

이는 매핑 전략을 선택하더라도 나중에 언제든 바꿀 수 있다는 뜻이다.

## '양방향' 매핑 전략

각 계층이 전용 모델을 가진 매핑 전략을 '양방향(Two-Way)' 매핑 전략이라고 한다.
(그림 8.2)

웹 계층에서는 웹 모델을 인커밍 포트에서 필요한 도메인 모델로 매핑하고, 인커밍 포트에 의해 반환된 도메인 객체를 다시 웹 모델로 매핑한다.

영속성 계층은 아웃고잉 포트가 사용하는 도메인 모델과 영속성 모델 간의 매핑과 유사한 매핑을 담당한다.

각 계층이 전용 모델을 변경하더라도 다른 계층에는 영향이 없고 단일 책임 원칙을 만족한다.

그러나 매핑 구현에 꽤 많은 시간이 들고 제네릭 코드와 리플렉션 뒤로 숨길 경우 디버깅하기 어려울 수 있다.

사실 도메인 모델이 계층 경계를 넘어서 통신하는 데 사용되고 있다는 것이 단점이다.

이로인해 도메인 모델이 바깥쪽 계층의 요구에 따른 변경에 취약해지게 된다.

## '완전' 매핑 전략

각 연산마다 별도의 입출력 모델을 사용한다.

웹 계층은 입력을 애플리케이션 계층의 커맨드 객체로 매핑할 책임을 가진다.

각 유스케이스는 전용 필드와 유효성 검증 로직을 가진 전용 커맨드를 가진다.

한 계층을 다른 여러 개의 커맨드로 매핑하는 데는 하나의 웹 모델과 도메인 모델 간의 매핑보다 더 많은 코드가 필요하다.

하지만 이렇게 매핑하면 여러 유스케이스의 요구사항을 함께 다뤄야 하느 ㄴ매핑에 비해 구현하고 유지보수하기가 훨씬 쉽다.

이 전략은 전역 패턴으로 추천되지 않지만, 웹 계층(혹은 인커밍 어댑터)과 애플리케이션 계층 사이에서 상태 변경 유스케이스의 경계를 명확하게 할 때 가장 빛을 발한다.

> 우리 팀은 이 패턴을 전역으로 사용하고 있다.
> 
> 귀찮음은 둘째치고 유스케이스를 나누는 것이 가장 큰 문제다.

어떤 매핑 전략도 모든 계층에 걸쳐 전역 규칙일 필요가 없다
(고 저자는 말하지만 개인적으로는 전역 규칙이 컨벤션으로 적합한게 아닐까 생각이 든다)

## '단방향' 매핑 전략

모든 계층의 모델들이 같은 인터페이스를 구현한다.

이 인터페이스는 관련 있는 특성에 대한 getter 메서드를 제공해서 도메인 모델의 상태를 캡슐화한다.

도메인 객체를 바깥 계층으로 전달하고 싶으면 매핑 없이 할 수 있다. 왜냐하면 도메인 객체가 인커밍/아웃고잉 포트가 기대하는 대로 상태 인터페이스를 구현하고 있기 때문이다.

이 매핑은 팩터리(factory)라는 DDD 개념과 잘 어울리는데 어떤 특정한 상태로부터 도메인 객체를 재구성할 책임을 가지고 있다.

이를 통해 바깥 계층에서 이 인터페이스를 구현한 객체를 전달하면 애플리케이션에서 이를 도메인 모델로 매핑할 수 있다.

각 계층이 한 방향으로만 매핑하기 때문에 '단방향' 매핑 전략이다.

이 전략은 계층 간의 모델이 비슷할 때 가장 효과적이다.

## 언제 어떤 매핑 전략을 사용할 것인가

'그때그때 다르다'

각 매핑 전략이 저마다 장단점을 갖고 있기 때문에 한 전략을 전체 코드에 대한 전역 규칙으로 정의하려는 충동을 이겨내야 한다.

소프트웨어는 시간이 지나며 변화를 거듭하기 때문에, 어제는 최선이었던 전략이 오늘은 최선이 아닐 수 있다.

언제 어떤 전략을 사용할지 결정하려면 팀 내에서 합의할 수 있는 가이드라인을 정해둬야 한다.

가이드라인은 어떤 상황에서 어떤 매핑 전략을 가장 먼저 택해야 하는가에 답할 수 있어야 한다.

또한 **왜** 해당 전략을 최우선으로 택해야 하는지도 설명할 수 있어야 한다.

예시)
- 변경 유스케이스를 작업하고 있다면 웹 계층과 애플리케이션 계층 사이에서는 유스케이스간의 결합을 제거하기 위해 '완전 매핑' 전략을 첫 번째 선택지로 택해야 한다.
이렇게 하면 유스케이스별 유효성 검증 규칙이 명확해지고 특정 유스케이스에서 필요하지 않은 필드를 다루지 않아도 된다.
- 변경 유스케이스를 작업하고 있다면 애플리케이션과 영속성 계층 사이에서는 매핑 오버헤드를 줄이고 빠르게 코드를 짜기 위해 '매핑하지 않기' 전략을 첫 번째 선택지로 둔다.
하지만 애플리케이션 계층에서 영속성 문제를 다뤄야 하게 되면 '양방향' 매핑 전략으로 바꿔서 영속성 문제를 해당 계층에 가둘 수 있게 한다.
- 쿼리 작업을 한다면 매핑 오버헤드를 줄이고 빠르게 코드를 짜기 위해 '매핑하지 않기' 전략이 웹 계층과 애플리케이션 계층 사이, 애플리케이션과 계층과 영속성 계층 사이에서 첫 번째 선택지가 돼야 한다.
하지만 애플리케이션 계층에서 영속성 문제나 웹 문제를 다뤄야 하게 되면 각각 '양방향' 매핑 전략으로 바꿔야 한다.

---

질문1.

